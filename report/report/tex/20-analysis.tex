\chapter{Аналитический раздел}
\label{cha:analysis}
%
% % В начале раздела  можно напомнить его цель
% IDEF0


В данном разделе производится анализ методов вычислений характеристик жидкостей и
их преобразований в графический формат.

Далее рассматриваются идеи применения данных методов к симуляции жидкостей и существующие решения в этой области.

% Обратите внимание, что включается не ../dia/..., а inc/dia/...
% В Makefile есть соответствующее правило для inc/dia/*.pdf, которое
% берет исходные файлы из ../dia в этом случае.

\section{Физическая модель}

Жидкости моделируются как векторное поле скорости жидкости и скалярное поле
плотности. Движение задаётся уравнениями Навье-Стокса \cite{inbook:bigenc}.

Далее рассматривается только движение воды (несжимаемой жидкости) в условиях постоянной температуры.

Тогда уравнения Навье-Стокса в векторной форме принимают следующий вид:
\begin{equation}
    \label{eq:navier-stokes}
    \frac{\partial \vec{v}}{\partial t} + \vec{v} \cdot \nabla\vec{v}= \vec{F} - \frac{1}{\rho} \nabla p + \eta\Delta\vec{v}.
\end{equation}

В уравнении \ref{eq:navier-stokes} $\vec{v}$ - скорость частицы воды,
                                   $t$ - время,
                                   ${\vec{F}}$ - внешняя удельная сила,
                                   $p$ - давление,
                                   $\eta = \frac{\mu}{\rho}$ - кинематический коэффициент вязкости,
                                   $\nabla$ - оператор Гамильтона,
                                   $\Delta$ - оператор Лапласа.

Данная физическая модель лежит в основе многих подходов симуляции жидкостей\cite{book:ash}. Их
обзор приведён далее.

В статистической физике модель поведения частиц жидкости описывается кинетическим
уравнением Больцмана. Данная модель применима для систем, где
есть ограничения на малую скорость частиц\cite{site:bolzman}.

\section{Существующие подходы к симуляции жидкостей}

В вычислениях поведения жидкости необходимо представить физическую модель в
 дискретном виде. Данную проблему решает вычислительная гидродинамика - совокупность
 теоретических, экспериментальных и численных методов, предназначенных для моделирования
 потоковых процессов.

Наиболее распространёнными методами описания характеристик жидкости в
вычислительной гидродинамике являются:
\begin{itemize}
    \item сеточные методы Эйлера;
    \item метод гидродинамики сглаженных частиц;
    \item методы, основанные на турбулентности;
    \item метод решёточных уравнений Больцмана.\cite{book:ash}
\end{itemize}

Сеточные методы Эйлера являются наиболее простым решением симуляции жидкостей
Они заключаются в поиске решения задачи Коши для функций,
заданных таблично. Для каждого узла функции уровня жидкости
 требуется вычисление значений разложений Тейлора в их окрестностям. Решение задачи Коши
 в данном случае аппроксимирует решение уравнений Навье-Стокса\cite{book:compmath}.

На основе сеточных методов Эйлера основан способ, который аппроксимирует
решение уравнений Навье-Стокса при помощи клеточного автомата\cite{conference:cellauto}.
Жидкость представляется в виде трёхмерной сетки.
Для каждой "клетки" жидкости в каждом новом поколении вычисляется новое состояние - кинетическая энергия и
уровень жидкости - на основе состояний "соседей фон Неймана" этой ячейки жидкости.

Метод гидродинамики сглаженных частиц и методы, основанные на турбулентности,
заключаются в выборе размера частицы ("длины сглаживания"), на котором их свойства
"сглаживаются" посредством функции ядра или интерполяции, и решения уравнений
Навье-Стокса с учётом вязкости и плотности. Это позволяет эффективно моделировать
поведение жидкостей, газов и даже использовать в астрофизике\cite{site:astro}.

 Метод решёточных уравнений Больцмана основан на кинетическом уравнении Больцмана,
 упомянутом ранее. Этот метод поддерживает многофазные жидкости, наличие теплопроводности
 и граничные условия на макроскопическом уровне\cite{site:habr-physics}.

В данной работе для симуляции воды используется метод клеточного автомата, поскольку
является наименее вычислительно сложной аппроксимацией уравнений Навье-Стокса\cite{conference:cellauto}.

\section{Анализ методов визуализации жидкостей}

Основными требованиями к методам симуляции жидкостей со стороны компьютерной графики
являются визуальная правдоподобность и скорость анимации.

Исходя из этих условий, в компьютерной графике используются специально модифицированные
и оптимизированные методы, основанные на указанных ранее. При этом решается задача объёмного
рендеринга - на каждый кадр требуется найти проекцию трёхмерного дискретного набора данных
о жидкости\cite{article:fastvolume}.

В настоящее время существует всего 2 принципиально различных техники объёмного рендеринга:
объёмный алгоритм марширующих лучей и реконструкция поверхности\cite{book:ash}.

\subsection{Объёмный алгоритм марширующих лучей}

Данная техника состоит в том, чтобы создать виртуальный экран и далее проследить
путь луча до тех пор, пока он проходит сквозь анимируемые объекты. В итоге луч
позволяет определить цвет каждого отдельного пикселя. Настоящий алгоритм трассировки лучей
имеет значительную вычислительную сложность, поэтому его часто заменяют на
правдоподобные аппроксимации\cite{book:ash}.

Одним из способов аппроксимации является трассировки лучей путём
замены полигонов на вокселы. Это позволяет существенно повышать производительность
анимации за счёт возможностей параллелизма и снижения вычислительной сложности за счёт упрощения
функции знака расстояния между источником света и гранями воксела\cite{book:ash}.
Недостатком данного подхода является то, что для хранения вокселов требуется большее количество
памяти, чем для хранения полигонов.

Другим популярным методом является метод срезов объёмных текстур так же, как и воксельный, является математическим упрощением алгоритма трассировки лучей\cite{site:raymarching}.
Данные сцены представляются в виде 3D текстуры. Рендеринг производится с самого дальнего
 по отношению к наблюдателю слоя текстуры. В итоге видимыми являются ближайшие из частей
 слоя.
 В качестве составляющих срезов могут быть использованы как вокселы, так и полигоны.
 Этот способ оптимизирован аппаратно для некоторых графических процессоров
 и в этом случае имеет преимущество перед воксельным методом по времени работы.

\subsection{Реконструкция поверхности}

Реконструкцией поверхности, или трёхмерной реконструкцией, называют процесс
получения облика реальных объектов.

В качестве входных данных получают множество точек, характеризующее объект.
Далее выбирают точки на поверхности объекта так, что получают полигоны, которые
имеют необходимую конфигурацию для аппроксимации формы поверхности в её видимой части.
Набор результирующих полигонов - реконструированная модель.

Основным алгоритмом, реализующим этот метод, является алгоритм марширующих кубов.
Он широко используется в компьютерной и магнитно-резонансной томографии\cite{site:marchingcubes}.

Идея алгоритма состоит в том, что для кубов, находящихся на поверхности объекта, известно,
какие точки лежат внутри объекта и какие снаружи. Это позволяет выбрать
приближающий полигон так, чтобы его вершины находились на отрезках, соединяющих вершины куба,
в примерных точках реального пересечения с объектом. Также можно объединять полигоны на одной поверхности
для оптимизации их хранения.

Таким образом, однажды применив алгоритм, можно использовать объект в анимации, если
он не изменяет форму поверхности.

Для предметов, теряющих форму (например, жидкостей), требуется повторное вычисление
реконструированной поверхности. Подобные вычисления имеют значительную сложность,
поэтому на практике, как правило, не используются\cite{book:ash}. Как и в случае
с методом марширующих лучей, существуют аппаратные ускорители для данного решения\cite{site:gvdb}.

\subsection{Оптимизации воксельного способа решения задачи объёмного рендеринга}

Существуют случаи, в которых система объёмного рендеринга получает на вход трёхмерные данные, в
 которых есть области, не требующие отрисовки. В подобных ситуациях следует пропускать вычисление
 результирующего изображения для пустого пространства\cite{article:asvo}.

Для хранения вокселов можно использовать различные структуры данных. Наиболее простой является
трёхмерный массив вокселов. При хранении вокселов в виде массива может требоваться значительное
количество памяти, даже если исходная информация достаточно однородная.
Поэтому для оптимизации хранения применяют такие структуры данных, как октодерево и разреженное бинарное дерево\cite{article:asvo}.

Использование иерахических структур данных имеет следующий недостаток - они статичны, и их
использование для моделей, теряющих форму, требует перестроение всего дерева\cite{article:asvo}.

Поскольку вода теряет свою форму, были предложены оптимизации не для хранения вокселов, а для
обработки лучей и самих данных симуляции. Данные оптимизации основаны на принципах обработки
чисел с плавающей запятой на аппаратном обеспечении, а также на возможности ускорения
вычислений за счёт параллелизма\cite{book:ash}.

\subsection{Вывод}

В данной работе используется метод реконструкции поверхности, который используется
совместно с подходом марширующих лучей. В качестве способа реконструкции используется оптимизация
марширующих кубов для поиска больших прямоугольников на воксельных поверхностях.

В качестве структуры данных для хранения вокселов предлагается использовать хеш-таблицу, в которой хешами являются
координаты воксела. Если воксел присутствует в сцене, то для него найдётся соответствующее логическое значение из
 хеш-таблицы. Данный способ позволяет избежать хранения в памяти пустого пространства сцены.

% вывод по разделу

\section{Анализ алгоритмов визуализации вокселов}

Ранее рассматриваются методы для описания сцены из вокселов, которая представляет собой
результат симуляции воды. Для их визуализации выбран метод реконструкции поверхности
совместно с подходом алгоритма марширующих лучей. В данном методе предусмотрена возможность использования множества стандартных
алгоритмов компьютерной графики для удаления невидимых линий и поверхностей, а также закрашивания \cite{book:ash}. Далее производится анализ этих алгоритмов визуализации.

\subsection{Анализ алгоритмов удаления невидимых линий и поверхностей}

В данном подразделе рассматриваются алгоритмы для удаления невидимых линий и поверхностей, пригодные
для использования в ранее указанном методе:
\begin{itemize}
    \item алгоритм c использованием Z-буферизации;
    \item алгоритм с использованием марширующего луча и функции знака расстояния.
\end{itemize}

\subsubsection{Алгоритм с использованием Z-буферизации}

Далее описывается суть алгоритма с использованием Z-буферизации.

\begin{enumerate}
    \item Создаётся двумерный массив - Z-буфер, каждый элемент которого соответствует
    пикселю изображения.
    \item Полученную с помощью реконструкции поверхности триангулированную сетку разбивают на
    треугольники и находят их проекции на картинную плоскость.
    \item Для каждого спроецированного
    треугольника вычисляется объемлющий прямоугольник.
    \item Для каждого пикселя внутри объемлющего прямоугольника вычисляется значение глубины на основе координат вершин спроецированного треугольника.
    \item Если значение Z-буфера для данного пикселя меньше, чем значение глубины в нём, то в Z-буфер записывается данное значение глубины. В буфер изображения записывается данный пиксель.
\end{enumerate}

На выходе алгоритма - буфер изображения, каждый пиксель которого окрашен в цвет ближайшего треугольника.

Достоинства алгоритма:
\begin{itemize}
    \item возможна параллельная обработка треугольников;
    \item не требуется сортировка вокселов;
    \item возможно аппаратное ускорение для чтения и записи из Z-буфера.
\end{itemize}

Недостатком является значительное использование памяти, но для современных
вычислительных систем это часто оказывается приемлемым\cite{site:depthbuffer}.

\subsubsection{Алгоритм с использованием марширующих лучей и функции знака расстояния}

Для данного алгоритма требуется задание функции для каждого объекта сцены,
 значение которой положительно, если выбранная точка находится снаружи объекта сцены,
 и отрицательно, если выбранная точка находится внутри объекта сцены.

Далее для каждого луча последовательно выбирают точки до тех пор, пока значение функции знака положительно. Если её значение стало отрицательным, то найдено пересечение, следовательно, данную точку можно записывать в результат.

Достоинства алгоритма:
\begin{itemize}
    \item возможно определение реалистичного цвета поверхности на основе пройденного расстояния луча;
    \item возможно использование многих источников света;
    \item возможно использование обратного алгоритма марширующих лучей(от объектов к картинной плоскости), в котором допустима параллельная обработка лучей.
\end{itemize}

Недостатки алгоритма:
\begin{itemize}
    \item зависит от выбора функции знака расстояния;
    \item вычислительно сложнее, чем алгоритм с использованием Z-буферизации\cite{site:raymarching}.
\end{itemize}

\subsubsection{Вывод}

В результате выбран алгоритм с использованием Z-буферизации, поскольку временные
затраты на вычисление расстояния в алгоритме марширующих лучей больше.

\subsection{Анализ алгоритмов закрашивания}

Для создания более реалистичного изображения следует использовать некоторую модель освещения.
Наиболее точным методом является трассировка лучей\cite{site:raymarching}, но, как было описано ранее, данная модель требует значительных вычислительных ресурсов.

Далее будут рассмотрены некоторые из возможных аппроксимаций для закрашивания поверхностей вокселов.

\subsubsection{Закраска по Ламберту}

Суть метода постоянного закрашивания (по Ламберту) заключается в том, что
на каждом полигоне определяется освещённость в произвольной точке, и полученное значение
используется для всего полигона\cite{site:fill}. В результате изображение имеет явный полигональный характер.
С точки зрения закраски полигонов, которые находятся на поверхности воксела, - это самый эффективный метод закрашивания с учётом освещения\cite{site:fill}.

\subsubsection{Закраска по Гуро}

В отличие от закраски по Ламберту, в закраске по Гуро используется билинейная интерполяция
интенсивностей света в каждой вершине полигона. Данный метод устраняет дискретность интенсивностей и работает верно в диффузной модели освещения. Зеркальное освещение может быть нарушено, так как происходит усреднение
векторов нормалей\cite{site:fill}.

\subsubsection{Закраска по Фонгу}

В данном методе производится билинейная интерполяция векторов нормалей в каждой из вершин, что
позволяет достичь более реалистичного изображения, чем в методе Гуро. Из недостатков выделяют
большую трудоёмкость, чем в методе Гуро, а также существуют случаи, в которых модель Фонга создаёт
эффект полос Маха\cite{site:fill}.

\subsubsection{Вывод}

В дальнейшем используется метод закраски по Ламберту, так как он наиболее эффективен по времени при закраске граней вокселов среди всех методов закраски с учётом освещения.

\section{Вывод}

Исходя из полученных сведений о достоинствах и недостатках каждого из методов объёмного
рендеринга в дальнейшем рассматривается реализация с помощью оптимизированного метода марширующих кубов. Она обеспечивает
возможность изменения формы жидкости и эффективное удаление невидимых линий и поверхностей посредством Z-буферизации.
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "rpz"
%%% End:
